---
title: "Time series analysis and visualization using dtwSat"
author: "Victor Maus^[National Institute for Space Research, Avenida dos Astronautas 1758, 12227010, São José dos Campos, Brazil.], ^[Institute for Geoinformatics, University of Münster, Heisenbergstraße 2, 48149 Münster, Germany]"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Time series analysis and visualization using dtwSat}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r dtwSat-usage, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  results = "hide"
)
```

This section describes how to classify one time series, using examples that come with the \pkg{dtwSat} package. We will show how to match three temporal patterns ("soybean", "cotton", and  "maize") to subintervals of a longer time series. The attributes of these time series have been extracted from a set of MODIS MOD13Q1 [@Friedl:2010] images and include vegetation indexes "ndvi", "evi", and original bands "nir", "red", "blue", and "mir". In this example, the classification of crop types for the longer time series is known. The inputs for the example are: (a) a \code{zoo} object with the longer time series, reffered to as \code{example_ts}; and (b) a list of \code{zoo} objects with the smaller time series, with the temporal patterns of "soybean", "cotton", and "maize",  reffered to as \code{patterns.list} as shown in Figure \ref{fig:temporal-patterns-list}. 
```{r, echo = TRUE, eval = TRUE, results = 'markup'}
library(dtwSat)
# List of temporal patterns 
names(patterns.list)
# Example of longer time series  
head(example_ts, n = 2)
```

The attributes of the time series in Figure \ref{fig:temporal-patterns-list} allow us to distinguish the three crop types. The algorithm uses both amplitude and phase information to classify the phenological cycles in the longer time series. The EVI peak of the "soybean" time series has a similar amplitude as that of "cotton". However, the series peaks in late December while the peak of the "cotton" series is in early April. The EVI peak of the "maize" time series is at the same period as the peak of "cotton". However, the "maize" time series has smaller amplitude than the "cotton" one. By combining shape and time information, we get a better classification. 
```{r temporal-patterns-list, echo = FALSE, eval = TRUE, fig.path='figure/', fig.width=6, fig.height=5, fig.align='center', fig.cap='Time series are based on MODIS product MOD13Q1 \\citep{Friedl:2010}. Temporal patterns of soybean, cotton, and maize (top) and a time series with its ground truth crop classes (bottom).', fig.pos='!h'}
# Create data.frame with sequence of class labels and plotting position 
df.text = data.frame(
  y=.98, text = c("Soybean", "Cotton", "Soybean", "Cotton", "Soybean", "Maize", "Soybean", "Maize"),
  x=seq(from=as.Date("2009-11-01"), to=as.Date("2013-05-01"), by="6 month"), stringsAsFactors = FALSE
  )
df.ts = data.frame(Time=index(example_ts), data.frame(example_ts), Pattern = rep("Time series", nrow(example_ts)))
df.ts = melt(df.ts, id.vars = c("Time", "Pattern"))
# Plot temporal patterns 
gp1 = plotPatterns(patterns.list) + theme(legend.position = "none") + xlab("")
# Plot example time series and class labels 
gp2 = ggplot(df.ts, aes(x=Time, y=value, group=variable, colour=variable)) + 
  facet_wrap(~Pattern) + 
  geom_line() + 
  xlab("Time") + 
  guides(col = guide_legend(ncol = 1)) + 
  annotate(geom="text", x=df.text$x, y=df.text$y, label=df.text$text, size = 2, family="Helvetica")
# Print plot arrange
grid.arrange(gp1, gp2)
```

Each subinterval of the \code{example_ts} time series has a known phenological cycle. We will now compare the known information with the result of the TWDTW algorithm. To do this, we use the function \code{twdtw} that returns an \proglang{R} object of class \code{twdtw-class} with all matches of each temporal pattern in the time series. This is a \code{S4} class with 4 slots. The first is \code{call}, an object of class \code{call}, that stores the function that created the object. The second and third are the unclassified time series \code{x}, and the \code{list} of temporal patterns \code{patterns}, respectively. The fourth is \code{alignments}, a \code{list} that has detailed information about the matches between the patterns and the time series.
```{r, echo = TRUE, eval = TRUE, results = 'markup'}
matches = twdtw(x = example_ts, patterns = patterns.list,
             weight.fun = logisticWeight(alpha = -0.1, beta = 100), keep=TRUE)
class(matches)
slotNames(matches)
show(matches)
summary(matches)
```
Setting the argument \code{keep=TRUE} the function retrieves the complete information of the matches that is used in some plot methods for \code{twdtw-class}. By default this parameter is set \code{FALSE} to reduce the memory usage while processing bigger amount of data. The argument \code{weight.fun} adds the time-weight to the dynamic time warping analysis [@Maus:2016]. By default the time-weight is zero, meaning that the function will run a standard dynamic time warping analysis. The argument \code{x} is \code{zoo} object with the unclassified time series and \code{patterns} a list of \code{zoo} objects with the temporal patterns. 

In our example we used a logist weight function, however, one can use any function that receive and performs computation on a matrix. \pkg{dtwSat} provides two in-built functions: \code{linearWeight} and \code{logisticWeight}. The \code{linearWeight} function with slope \code{a} and intercept \code{b} is given by 
$$
    \omega = a g(t_1,t_2) + b,
    \label{eq:lineartw}
$$
and the \code{logisticWeight} with midpoint $\beta$, and steepness $\alpha$, given by
$$
    \omega = \frac{1}{1 + e^{-\alpha(g(t_1,t_2)-\beta)} }.
    \label{eq:nonlineartw}
$$
The function $g$ is the absolute difference in days between two dates, $t_1$ and $t_2$. The linear function creates a strong time constraint even for small time differences. While the logistic function has a low weight for small time warps and significant costs for bigger time warps, cf. Figure \ref{fig:logist-time-weight}. In previous studies by @Maus:2016 the logistic-weight had better results than the linear-weight for land cover classification. 
```{r logist-time-weight, echo = FALSE, eval = TRUE, fig.path='figure/', out.width=paste0(page_width/2,'in'), fig.align='center', fig.cap='Logistic time-weight function \\code{logisticWeight} with steepness \\code{alpha=-0.1} and midpoint \\code{beta=100}. The $x$ axis shows the absolute difference between two dates in days and the $y$ axis shows the time-weight.', fig.pos='!h'}
# Maximum time difference in days 
max_diff = 366/2
# Set parameters 
alpha = -0.1
beta = 100
a = 1/max_diff
# Define the logistic weight 
log_fun = logisticWeight(alpha, beta)
# Define the linear weight 
lin_fun = linearWeight(a)
# Build data.frame with linear and logistic time-weight 
Difference = 0:max_diff
df_weight = data.frame(Difference, Logistic=log_fun(Difference), Linear=lin_fun(Difference))
names(df_weight) = c("Difference", paste0("Logistic steepness: ",alpha," and midpoint: ",beta), paste0("Linear slop: ",round(a,3)))
# REshape and plot weight curves 
df_weight = melt(df_weight, id.vars = "Difference")
names(df_weight)[-1] = c("Functions","Weight")
ggplot(df_weight, aes_string(x="Difference", y="Weight", group="Functions", linetype="Functions")) + 
  geom_line() + xlab("Time difference (days)")  + 
  theme(text = element_text(size = 10, family="Helvetica"), 
        plot.title = element_text(size = 10, family="Helvetica", face="bold"),
        axis.title = element_text(size = 10, family="Helvetica"),
        legend.position = c(.3,.85), legend.background = element_rect(fill="transparent"))
```

\pkg{dtwSat} has several methods for analysis and visualisation of objects \code{twdtw-class}. Next example uses \code{plotMatches} to show the four best matches of the "soybean" pattern to the long-term time series, cf. Fig. (\ref{fig:twdtw-matches}). 
```{r twdtw-matches, echo = TRUE, eval = TRUE, fig.path='figure/', fig.width=page_width, fig.height=page_height/3, fig.align='center', fig.cap=c('The four best matches of the phenological cycle of "Soybean" to the time series using a logistic time-weight. The solid black line is the unclassified time series; the coloured lines are the temporal patterns; and the grey dashed lines are the respective matching points.'), fig.pos='!h'}
plotMatches(matches, p.names = "Soybean", n = 4)
```

The next example uses \code{plotAlignments} to show all alignments for all temporal patterns. In Figure \ref{fig:alignments-all-patterns} we can matches with dissimilarity measure lower than three aligned to the time series. Note that many subintervals of the long-term time series have more then one match. This is because the TWDTW analysis is independent for each temporal pattern. 
```{r alignments-all-patterns, echo = TRUE, eval = TRUE, fig.path='figure/', fig.width=page_width, fig.height=page_height/2.5, fig.align='center', fig.cap=c('Alignments and dissimilarity measure of the patterns "soybean", "cotton", and "maize" to the subintervals of the long-term time series using a logistic time-weight. The solid black line is the EVI time series, and the coloured lines are the alignments of the patterns.'), fig.pos='!h'}
plotAlignments(matches, attr = "evi", threshold = 3)
```

Now using the matches and their associated dissimilarity measures we can classify the subintervals of the long-term time series. For that we set classification periods of 6 months from September 2009 to September 2013, and a minimum overlap between the match and the classification period of 50%. This means that, to be considered, at least 50% of the match needs to be within the classification period. We use the graphical method \code{plotClassification} to show final classification of the time series. 
```{r time-series-classification, echo = TRUE, eval = TRUE, fig.path='figure/', fig.width=page_width, fig.height=page_height/2.5, fig.align='center', fig.cap=c('Classification of each 6 months periods of the time series using results of the TWDTW analysis with logistic time-weight. The solid lines are the attributes of the time series, the background colours indicate the classification of the periods.'), fig.pos='!h'}
plotClassification(x = matches, from = as.Date("2009-09-01"),
                   to = as.Date("2013-09-01"), by = "6 month", 
                   overlap = 0.5) + theme(legend.position = "bottom")
```
If we compare the results of the classificytion in Fig. (\ref{fig:time-series-classification}) to the time sereis in Fig. (\ref{fig:temporal-patterns-list}) we see that the algorithm has classified correcly all the eight subintervals from 2009 to 2013, which are, respectively: "Soybean", "Cotton", "Soybean", "Cotton", "Soybean", "Maize", "Soybean", "Maize". 


# References








